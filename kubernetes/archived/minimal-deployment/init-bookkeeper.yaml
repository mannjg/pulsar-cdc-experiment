apiVersion: batch/v1
kind: Job
metadata:
  name: bookkeeper-init
  namespace: pulsar
  labels:
    app: bookkeeper-init
spec:
  template:
    metadata:
      labels:
        app: bookkeeper-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-zookeeper
        image: busybox:1.36
        command:
        - sh
        - -c
        - >
          until nslookup zookeeper.pulsar.svc.cluster.local; do
            echo waiting for zookeeper;
            sleep 2;
          done &&
          sleep 10
      containers:
      - name: init-bookkeeper-metadata
        image: apachepulsar/pulsar:3.3.9
        command:
        - sh
        - -c
        - >
          export zkServers=zookeeper:2181 &&
          bin/apply-config-from-env.py conf/bookkeeper.conf &&
          bin/bookkeeper shell metaformat -nonInteractive || true
        env:
        - name: PULSAR_MEM
          value: "-Xms256m -Xmx256m"
        - name: zkServers
          value: "zookeeper:2181"
        - name: metadataServiceUri
          value: "metadata-store:zk:zookeeper:2181"
