# Pulsar CDC Experiment - Complete Helm Values
# This configuration includes the SecurityContext customizer for Kubernetes runtime
# Chart version: pulsar-3.9.0
# Pulsar version: 3.3.5

# Initialize cluster on install
initialize: true

# Override default Pulsar image tag globally
defaultPulsarImageTag: "3.3.5"

#Override images for all components to use 3.3.5
images:
  zookeeper:
    tag: "3.3.5"
  bookie:
    tag: "3.3.5"
  broker:
    tag: "3.3.5"
  toolset:
    tag: "3.3.5"
  proxy:
    tag: "3.3.5"
  functions:
    tag: "3.3.5"

# Zookeeper configuration - minimal setup for local testing
zookeeper:
  replicaCount: 1
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
  configData:
    PULSAR_MEM: "-Xms128m -Xmx256m"
    PULSAR_GC: "-XX:+UseG1GC"
  podMonitor:
    enabled: false

# BookKeeper configuration - minimal setup
bookkeeper:
  replicaCount: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 50m
  configData:
    PULSAR_MEM: "-Xms256m -Xmx512m"
    PULSAR_GC: "-XX:+UseG1GC"
  podMonitor:
    enabled: false

# Broker configuration with Kubernetes runtime and SecurityContext customizer
broker:
  replicaCount: 1
  resources:
    requests:
      memory: 256Mi
      cpu: 50m
  configData:
    PULSAR_MEM: "-Xms256m -Xmx512m"
    PULSAR_GC: "-XX:+UseG1GC"
    managedLedgerDefaultEnsembleSize: "1"
    managedLedgerDefaultWriteQuorum: "1"
    managedLedgerDefaultAckQuorum: "1"
    functionsWorkerEnabled: "true"

    # Configure Kubernetes runtime for Functions Worker
    PF_functionRuntimeFactoryClassName: "org.apache.pulsar.functions.runtime.kubernetes.KubernetesRuntimeFactory"
    PF_functionRuntimeFactoryConfigs_jobNamespace: "pulsar"
    PF_functionRuntimeFactoryConfigs_pulsarDockerImageName: "apachepulsar/pulsar:3.3.5"
    PF_functionRuntimeFactoryConfigs_imagePullPolicy: "IfNotPresent"
    PF_functionRuntimeFactoryConfigs_pulsarRootDir: "/pulsar"

    # CRITICAL: Security customizer configuration (same property name for Pulsar 3.x and 4.x)
    PF_runtimeCustomizerClassName: "com.custom.pulsar.SecurityEnabledKubernetesManifestCustomizer"

    # Pod SecurityContext settings
    PF_runtimeCustomizerConfig_podSecurityContext_runAsNonRoot: "true"
    PF_runtimeCustomizerConfig_podSecurityContext_runAsUser: "10000"
    PF_runtimeCustomizerConfig_podSecurityContext_runAsGroup: "10000"
    PF_runtimeCustomizerConfig_podSecurityContext_fsGroup: "10000"

    # Container SecurityContext settings
    PF_runtimeCustomizerConfig_containerSecurityContext_runAsNonRoot: "true"
    PF_runtimeCustomizerConfig_containerSecurityContext_runAsUser: "10000"
    PF_runtimeCustomizerConfig_containerSecurityContext_readOnlyRootFilesystem: "false"
    PF_runtimeCustomizerConfig_containerSecurityContext_allowPrivilegeEscalation: "false"
    PF_runtimeCustomizerConfig_containerSecurityContext_capabilities_drop_0: "ALL"

  # Init container to download artifacts from jar-server
  initContainers:
  - name: download-broker-artifacts
    image: curlimages/curl:8.5.0
    command:
    - sh
    - -c
    - |
      echo "Downloading broker artifacts..."

      # Download libs
      echo "Downloading libs..."
      curl -f -v -o /broker-libs/pulsar-security-customizer-1.0.0.jar \
        http://jar-server.pulsar.svc.cluster.local/libs/pulsar-security-customizer-1.0.0.jar

      echo "Download complete. Verifying artifacts..."
      ls -lhR /broker-libs
    volumeMounts:
    - name: broker-libs
      mountPath: /broker-libs

  # Volumes for artifact storage (semantic naming by artifact type)
  extraVolumes:
  - name: broker-libs
    emptyDir: {}
  # Future: add broker-functions and broker-connectors volumes as needed

  # Mount artifacts to appropriate Pulsar directories
  extraVolumeMounts:
  - name: broker-libs
    mountPath: /pulsar/lib/pulsar-security-customizer-1.0.0.jar
    subPath: pulsar-security-customizer-1.0.0.jar
    readOnly: true
  # Future: add mounts for /pulsar/functions/ and /pulsar/connectors/

  podMonitor:
    enabled: false

# Proxy configuration - minimal setup
proxy:
  replicaCount: 1
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
  configData:
    PULSAR_MEM: "-Xms128m -Xmx256m"
    PULSAR_GC: "-XX:+UseG1GC"
  podMonitor:
    enabled: false

# Enable Pulsar Functions with runtime customization
functions:
  enabled: true
  enableCustomizerRuntime: true
  functionReplicaCount: 1
  rbac:
    limit_to_namespace: true
  resources:
    requests:
      memory: 256Mi
      cpu: 50m

# Disable monitoring components not needed for basic testing
pulsar_manager:
  enabled: false

grafana:
  enabled: false

prometheus:
  enabled: false

kube-prometheus-stack:
  enabled: false

victoria-metrics-k8s-stack:
  enabled: false

# Disable all PodMonitor resources
monitoring:
  podMonitor:
    enabled: false

# Disable recovery PodMonitor
pulsar_metadata:
  component: pulsar-init
  podMonitor:
    enabled: false

# Volumes - use smaller sizes for testing
volumes:
  persistence: true
  useSingleCommonVolume: true
  journal:
    size: 5Gi
  ledgers:
    size: 10Gi
