# Debezium CDC with Pulsar - Setup Summary

## Overview
Successfully deployed a PostgreSQL database with Debezium CDC connector that streams changes to Apache Pulsar.

## Architecture
- **PostgreSQL**: Running in `postgres` namespace using Debezium PostgreSQL image (version 16)
- **Pulsar**: Running in `pulsar` namespace (version 4.0.2)
- **Debezium Connector**: Pulsar Source Connector streaming changes from PostgreSQL to Pulsar

## Components Deployed

### 1. PostgreSQL Database
- **Namespace**: `postgres`
- **Image**: `debezium/postgres:16`
- **Service**: `postgres.postgres.svc.cluster.local:5432`
- **Database**: `inventory`
- **User/Password**: `postgres/postgres`
- **Table**: `customers` (id, name, email, created_at)

### 2. Pulsar Installation
- **Namespace**: `pulsar`
- **Components**:
  - ZooKeeper (1 pod)
  - BookKeeper (1 pod)
  - Broker (1 pod) with Functions Worker enabled
- **Broker Service**: `broker-external` (NodePort 30650/30080)

### 3. Debezium CDC Connector
- **Name**: `debezium-postgres-source`
- **Type**: Pulsar Source Connector
- **Connector Archive**: `/pulsar/download/pulsar-io-debezium-postgres-3.3.2.nar`
- **Topic**: `persistent://public/default/dbserver1.public.customers`
  - Note: Topic name is auto-generated as `<server-name>.<schema>.<table>`
  - Server name: `dbserver1`
- **Configuration**:
  - Snapshot mode: initial
  - Plugin: pgoutput
  - Replication slot: debezium
  - Publication: dbz_publication (auto-created, filtered)

## Key Files

### Kubernetes Manifests
- `postgres-debezium.yaml` - PostgreSQL deployment with Debezium image

### Connector Configuration
- `debezium-postgres-source.json` - Debezium connector configuration

## Testing the CDC Pipeline

### Insert Data into PostgreSQL
```bash
microk8s kubectl exec -n postgres $(microk8s kubectl get pod -n postgres -l app=postgres -o jsonpath='{.items[0].metadata.name}') -- \
  psql -U postgres -d inventory -c "INSERT INTO customers (name, email) VALUES ('Test User', 'test@example.com');"
```

### Consume CDC Messages from Pulsar
```bash
microk8s kubectl exec -n pulsar broker-0 -- \
  bin/pulsar-client consume persistent://public/default/dbserver1.public.customers \
  -s "test-subscription" -n 0 -p Earliest
```

## Sample CDC Message Format
```json
{
  "before": null,
  "after": {
    "id": 1,
    "name": "John Doe",
    "email": "john.doe@example.com",
    "created_at": 1763741883901236
  },
  "source": {
    "version": "1.9.7.Final",
    "connector": "postgresql",
    "name": "dbserver1",
    "ts_ms": 1763741883902,
    "snapshot": "false",
    "db": "inventory",
    "schema": "public",
    "table": "customers",
    "txId": 746,
    "lsn": 27565472
  },
  "op": "c",
  "ts_ms": 1763741884346
}
```

### Message Fields
- `op`: Operation type (`c` = create/insert, `u` = update, `d` = delete)
- `before`: Previous row state (null for inserts)
- `after`: New row state (null for deletes)
- `source`: Metadata about the change event
- `ts_ms`: Timestamp when Debezium processed the event

## Useful Commands

### Check Connector Status
```bash
microk8s kubectl exec -n pulsar broker-0 -- \
  bin/pulsar-admin sources status --name debezium-postgres-source
```

### List All Topics
```bash
microk8s kubectl exec -n pulsar broker-0 -- \
  bin/pulsar-admin topics list public/default
```

### View Topic Stats
```bash
microk8s kubectl exec -n pulsar broker-0 -- \
  bin/pulsar-admin topics stats persistent://public/default/dbserver1.public.customers
```

### Delete Connector (if needed)
```bash
microk8s kubectl exec -n pulsar broker-0 -- \
  bin/pulsar-admin sources delete --name debezium-postgres-source
```

## Notes
- The Pulsar Functions Worker must be enabled for connectors to work
- Topic names are auto-generated by Debezium based on server name and table name
- The Debezium PostgreSQL image comes pre-configured with WAL level = logical
- Messages contain full row data (before and after states) for all operations
